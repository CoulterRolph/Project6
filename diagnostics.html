<!DOCTYPE html>
<!--[if lt IE 9]>
	<script src=http://html5shiv.googlecode.com/svn/trunk/html5.js></script>
<![endif]-->
<html>

<!-- This is the diagnostics page of our project, where we can see the status of the elevator and its components as well as change the desired mode -->

<!-- header section with title, meta information, stylesheets, and bootstrap -->

<head>
    <title> Project VI - Index </title>
    <meta name="description" content="This is the home page of our project" />
    <meta name="robots" content="noindex nofollow" />
    <meta http-equiv="author" content="Coulter, David, Stuart" />
    <meta http-equiv="pargma" content="no-cache" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="Photos/Logo.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/Sidebar.css" type="text/css" rel="stylesheet" />
    <link href="css/Topbar.css" type="text/css" rel="stylesheet" />
    <link href="css/Button.css" type="text/css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<!-- body section with the main content of the page -->

<body>

    <!-- Authentication check to see if session has been created with authenticated user -->
    <script>
        fetch('php/GUIAuthentication.php')
            .then(r => r.json())
            .then(data => {
                if (!data.authenticated) {
                    window.location.href = 'login.html?error=auth';
                }
            });
    </script>

    <div id="page" class="container-fluid">
        <div class="row min-vh-100">

            <!-- sidebar section with the navigation links -->
            <div class="col-md-3 col-lg-2" id="sidebar">
                <script src="js/sidebar.js"></script>
            </div>

            <section class="col-md-9 col-lg-10 px-md-4 py-4 position-relative">

                <!-- Mode Selector Dropdown -->
                <div class="dropdown position-absolute top-0 end-0 m-4">
                    <button class="btn btn-primary dropdown-toggle" type="button" id="modeSelector"
                        data-bs-toggle="dropdown" aria-expanded="false">
                        Select Mode
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="modeSelector">
                        <li><a class="dropdown-item" href="#" onclick="elevatorMode(1)">Normal</a></li>
                        <li><a class="dropdown-item" href="#" onclick="elevatorMode(2)">Maintenance</a></li>
                        <li><a class="dropdown-item" href="#" onclick="elevatorMode(3)">Sabath</a></li>
                        <li><a class="dropdown-item" href="#" onclick="elevatorMode(4)">Emergency</a></li>
                    </ul>
                </div>

                <!-- topbar section with the navigation links -->
                <nav class="mb-4 border-bottom pb-2">
                    <ul class="nav">
                        <li class="nav-item"><a class="nav-link topbar" href="Inside.html">Inside</a></li>
                        <li class="nav-item"><a class="nav-link topbar" href="Floor1.html">Floor 1</a></li>
                        <li class="nav-item"><a class="nav-link topbar" href="Floor2.html">Floor 2</a></li>
                        <li class="nav-item"><a class="nav-link topbar" href="Floor3.html">Floor 3</a></li>
                        <li class="nav-item"><a class="nav-link topbar topbarcurrent"
                                href="diagnostics.html">Diagnostics</a></li>
                    </ul>
                </nav>

                <!-- main chart with the diagnostics information querying the database -->
                <article class="mb-5 row justify-content-center g-4">
                    <div class="col-8">
                        <canvas id="floorChart" height="100"></canvas>
                    </div>
                </article>

                <!-- section for diagnostic status and messages, updated later in script -->
                <section class="row justify-content-center">
                    <div class="col-5 me-5">
                        <h2> Diagnostic Status:</h2>
                    </div>
                    <div class="col-5">
                        <h2>Diagnostic Messages:</h2>
                    </div>
                </section>

                <section class="row justify-content-center">
                    <div class="col-5 border shadow bg-light p-3 me-5">
                        <h4 id="elevator-status"> - ESE, it's in the game.</h4>
                    </div>
                    <div class="col-5 border shadow bg-light p-3">
                        <h4 id="elevator-message"> - Working hard or hardly working?</h4>
                    </div>
                </section>

            </section>
        </div>
    </div>

    <!-- script to handle elevator mode changes and update diagnostics -->
    <script>
        function elevatorMode(mode) {
            fetch('php/elevatorMode.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: 'elevatorMode=' + encodeURIComponent(mode)
            })
                .then(response => response.text())
                .then(data => {
                    alert(data); // Replace with UI update if needed
                })
                .catch(error => {
                    alert("Error: " + error);
                });
        }
    </script>

    <!-- script to handle chart updates and polling for diagnostics -->
    <script>
        let floorChart;
        const chartCtx = document.getElementById('floorChart').getContext('2d');

        // Initialize the chart with default data
        function initChart() {
            floorChart = new Chart(chartCtx, {
                type: 'bar',
                data: {
                    labels: ['Floor 1', 'Floor 2', 'Floor 3'],
                    datasets: [{
                        label: 'Elevator Diagnostic Levels',
                        backgroundColor: ['#0d6efd', '#198754', '#ffc107'],
                        data: [0, 0, 0]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                callback: function (value) {
                                    if (Number.isInteger(value)) {
                                        return value;
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        }
                    }
                }
            });
        }

        // Update the chart with new data
        function updateChart(data) {
            if (floorChart && data.floor1 !== undefined && data.floor2 !== undefined && data.floor3 !== undefined) {
                floorChart.data.datasets[0].data = [
                    parseFloat(data.floor1),
                    parseFloat(data.floor2),
                    parseFloat(data.floor3)
                ];
                floorChart.update();
            }
        }

        // Poll the server for diagnostics data
        function pollStatus() {
            fetch('php/diagnostics.php')
                .then(r => r.json())
                .then(data => {
                    const status = document.getElementById('elevator-status');
                    if (status && data.status !== undefined) {
                        status.textContent = data.status;
                    }

                    const message = document.getElementById('elevator-message');
                    if (message && data.messages !== undefined) {
                        message.textContent = data.messages;
                    }

                    updateChart(data);
                })
                .catch(err => console.error('LED poll error:', err));
        }

        // Initialize the chart and start polling for diagnostics data refreshing every 3 seconds
        initChart();
        pollStatus();
        setInterval(pollStatus, 3000);
    </script>

    <!-- Bootstrap JS for dropdown functionality -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>