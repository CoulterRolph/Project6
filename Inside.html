<!DOCTYPE html>
<!--[if lt IE 9]>
	<script src=http://html5shiv.googlecode.com/svn/trunk/html5.js></script>
<![endif] -->
<html>

<!-- This is the main GUI page for the inside of the elevator system. It allows users to control the elevator, view its status, and interact with various features. -->

<!-- header section with title, meta information, stylesheets, and bootstrap -->

<head>
	<title> Project VI - Index </title>
	<meta name="description" content="This is the home page of our project" />
	<meta name="robots" content="noindex nofollow" />
	<meta http-equiv="author" content="Coulter, David, Stuart" />
	<meta http-equiv="pargma" content="no-cache" />
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="icon" href="Photos/Logo.png" type="image/png">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-
		QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link href="css/Sidebar.css" type="text/css" rel="stylesheet" />
	<link href="css/Topbar.css" type="text/css" rel="stylesheet" />
	<link href="css/Button.css" type="text/css" rel="stylesheet" />
</head>

<!-- body section with the main content of the page -->

<body>

	<!-- Authentication check to see if session has been created with authenticated user -->
	<script>
		fetch('php/GUIAuthentication.php')
			.then(r => r.json())
			.then(data => {
				if (!data.authenticated) {
					window.location.href = 'login.html?error=auth';
				}
			});
	</script>

	<div id="page" class="container-fluid">
		<div class="row min-vh-100">

			<!-- Sidebar for navigation -->
			<div class="col-md-3 col-lg-2" id="sidebar">
				<script src="js/sidebar.js"></script>
			</div>

			<section class="col-md-9 col-lg-10 px-md-4 py-4">

				<!-- Topbar with navigation links -->
				<nav class="mb-4 border-bottom pb-2">
					<ul class="nav">
						<li class="nav-item"><a class="nav-link topbar topbarcurrent" href="Inside.html">Inside</a></li>
						<li class="nav-item"><a class="nav-link topbar" href="Floor1.html">Floor 1</a></li>
						<li class="nav-item"><a class="nav-link topbar" href="Floor2.html">Floor 2</a></li>
						<li class="nav-item"><a class="nav-link topbar" href="Floor3.html">Floor 3</a></li>
						<li class="nav-item"><a class="nav-link topbar" href="diagnostics.html">Diagnostics</a></li>
					</ul>
				</nav>

				<!-- Header for displaying the current floor -->
				<header class="mb-5 row">
					<div class="col-xs-12 text-center">
						<h1>Current Floor: <span class="badge bg-secondary" id="current-floor">2</span></h1>
					</div>
				</header>

				<!-- Main floor control button selection panel -->
				<article class="mb-5 row justify-content-center g-4">
					<div class="col-md-4 d-flex justify-content-end">
						<div class="p-5 border border-4 rounded-4 shadow bg-light h-100 d-flex flex-column justify-content-center"
							style="width:346px;">
							<div class="mb-2 text-center">
								<button id="floor3-btn" onclick="requestFloor(3)"
									class="btn btn-outline-primary med-btn">3</button>
							</div>
							<div class="mb-2 text-center">
								<button id="floor2-btn" onclick="requestFloor(2)"
									class="btn btn-outline-primary med-btn">2</button>
							</div>
							<div class="text-center">
								<button id="floor1-btn" onclick="requestFloor(1)"
									class="btn btn-outline-primary med-btn">1</button>
							</div>
						</div>
					</div>

					<!-- Elevator control panel for opening and closing doors -->
					<div class="col-md-4 d-flex justify-content-center">
						<div class="p-5 border border-4 rounded-4 shadow bg-light h-100 d-flex flex-column justify-content-center"
							style="width:346px;">
							<div class="mb-5 text-center">
								<button class="btn btn-outline-primary med-btn">
									&lt;|&gt;
								</button>
							</div>
							<div class="text-center">
								<button class="btn btn-outline-primary med-btn">
									&gt;|&lt;
								</button>
							</div>
						</div>
					</div>

					<!-- Alarm and call button panel -->
					<div class="col-4 d-flex justify-content-start">
						<div class="p-5 border border-4 rounded-4 shadow bg-light h-100 d-flex flex-column justify-content-center"
							style="width:346px;">
							<div class="mb-5 text-center">
								<button id="alarm-btn" onclick="toggleAlarm()" class="btn btn-outline-danger med-btn">
									&#128276;
								</button>
							</div>

							<div class="text-center">
								<button id="call-btn" onclick="startCall()" class="btn btn-outline-primary med-btn">
									&#128222;
								</button>

							</div>
						</div>
					</div>
				</article>

				<!-- Status section for elevator status and messages -->
				<section class="row justify-content-center">
					<div class="col-5 me-5">
						<h2>Elevator Status:</h2>
					</div>
					<div class="col-5">
						<h2>Elevator Messages:</h2>
					</div>
				</section>
				<section class="row justify-content-center">
					<div class="col-5 border shadow bg-light p-3 me-5">
						<h4 id="elevator-status"> - ESE, it's in the game.</h4>
					</div>
					<div class="col-5 border shadow bg-light p-3">
						<h4 id="elevator-message"> - Working hard or hardly working?</h4>
						<div id="call-status" class="text-success mt-2" style="display: none;"></div>
					</div>
				</section>
		</div>
	</div>

	<!-- Polling functions to update LED status and elevator state -->
	<script>
		function pollLEDStatus() {
			fetch('php/floorLEDStates.php')
				.then(r => r.json())
				.then(data => {
					// Floor buttons
					const btn1 = document.getElementById('floor1-btn');
					if (btn1) {
						if (parseInt(data.requestedFloor1, 10) === 2) {
							btn1.classList.remove('btn-outline-primary');
							btn1.classList.add('btn-primary');
						} else {
							btn1.classList.remove('btn-primary');
							btn1.classList.add('btn-outline-primary');
						}
					}

					const btn2 = document.getElementById('floor2-btn');
					if (btn2) {
						if (parseInt(data.requestedFloor2, 10) === 2) {
							btn2.classList.remove('btn-outline-primary');
							btn2.classList.add('btn-primary');
						} else {
							btn2.classList.remove('btn-primary');
							btn2.classList.add('btn-outline-primary');
						}
					}

					const btn3 = document.getElementById('floor3-btn');
					if (btn3) {
						if (parseInt(data.requestedFloor3, 10) === 2) {
							btn3.classList.remove('btn-outline-primary');
							btn3.classList.add('btn-primary');
						} else {
							btn3.classList.remove('btn-primary');
							btn3.classList.add('btn-outline-primary');
						}
					}

					// Update current floor
					const currentFloor = document.getElementById('current-floor');
					if (currentFloor && data.currentFloor !== undefined) {
						currentFloor.textContent = data.currentFloor;
					}

					// Update status
					const status = document.getElementById('elevator-status');
					if (status && data.status !== undefined) {
						status.textContent = data.status;
					}

					// Update message
					const message = document.getElementById('elevator-message');
					if (message && data.messages !== undefined) {
						message.textContent = data.messages;
					}
				})
				.catch(err => console.error('LED poll error:', err));
		}
	</script>

	<!-- script for handling alarm and call button functionality -->
	<script>
		function toggleAlarm() {
			fetch('php/getElevatorMode.php')
				.then(response => response.json())
				.then(data => {
					const currentMode = parseInt(data.elevatorMode);
					const newMode = currentMode === 4 ? 1 : 4;

					// Send POST to update mode
					fetch('php/elevatorMode.php', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/x-www-form-urlencoded'
						},
						body: 'elevatorMode=' + encodeURIComponent(newMode)
					})
						.then(response => response.text())
						.then(result => {
							if (newMode === 4) {
								triggerAlarmMode();
							} else {
								resetAlarmMode();
							}
						});
				})
				.catch(error => console.error("Error:", error));
		}

		function triggerAlarmMode() {
			document.getElementById('alarm-btn').classList.remove('btn-outline-danger');
			document.getElementById('alarm-btn').classList.add('btn-danger');

			document.getElementById('alarmSound').play();

			document.querySelectorAll('button').forEach(btn => {
				if (btn.id !== 'alarm-btn') {
					btn.disabled = true;
				}
			});
		}

		function resetAlarmMode() {
			const alarmAudio = document.getElementById('alarmSound');
			alarmAudio.pause();
			alarmAudio.currentTime = 0; // rewind to the start

			document.getElementById('alarm-btn').classList.remove('btn-danger');
			document.getElementById('alarm-btn').classList.add('btn-outline-danger');

			document.querySelectorAll('button').forEach(btn => {
				btn.disabled = false;
			});
		}
	</script>

	<!-- script for handling call button functionality -->
	<script>
		function startCall() {
			const callBtn = document.getElementById('call-btn');
			const callStatus = document.getElementById('call-status');
			const callSound = document.getElementById('callSound');

			if (!callBtn || !callStatus || !callSound) {
				console.error("Missing call button, status, or audio element.");
				return;
			}

			// Activate UI
			callBtn.classList.remove('btn-outline-primary');
			callBtn.classList.add('btn-primary');
			callSound.play().catch(e => console.error("Audio failed to play:", e));

			callStatus.style.display = 'block';
			callStatus.textContent = "Calling...";

			setTimeout(() => {
				callStatus.textContent = "Call Connected";

				setTimeout(() => {
					callStatus.style.display = 'none';
					callBtn.classList.remove('btn-primary');
					callBtn.classList.add('btn-outline-primary');
					callSound.pause();
					callSound.currentTime = 0;
				}, 10000); // Show "connected" for 3 seconds
			}, 5000); // Show "calling..." for 2 seconds
		}
	</script>

	<!-- Polling functions to update LED status and elevator state -->
	<script>
		// Remember the last floor requested and if we already played the audio
		let lastRequestedFloor = null;
		let arrivalAnnounced = false;

		function requestFloor(floorNum) {
			lastRequestedFloor = floorNum;
			arrivalAnnounced = false; // Allow arrival message to play again

			fetch('php/floorReq.php', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded'
				},
				body: 'floorRequest=' + encodeURIComponent(floorNum)
			})
				.then(response => response.text())
				.then(data => {
					// Optional: handle the response if you want
				})
				.catch(error => {
					alert("Request failed: " + error);
				});
		}

		function pollArrivalStatus() {
			fetch('php/floorLEDStates.php')
				.then(r => r.json())
				.then(data => {
					// Play arrival audio when elevator arrives at requested floor
					if (
						lastRequestedFloor !== null &&
						data.currentFloor !== undefined &&
						parseInt(data.currentFloor) === parseInt(lastRequestedFloor) &&
						!arrivalAnnounced
					) {
						const floorAudio = document.getElementById('arrived' + lastRequestedFloor);
						if (floorAudio) {
							floorAudio.play().catch(() => { });
						}
						arrivalAnnounced = true;
					}
					// Reset if elevator leaves the floor (so it will play again next time)
					if (
						lastRequestedFloor !== null &&
						data.currentFloor !== undefined &&
						parseInt(data.currentFloor) !== parseInt(lastRequestedFloor)
					) {
						arrivalAnnounced = false;
					}
				})
				.catch(err => console.error('Arrival poll error:', err));
		}

		// Start polling functions
		pollLEDStatus();
		pollArrivalStatus();
		setInterval(pollLEDStatus, 3000);
		setInterval(pollArrivalStatus, 3000);
	</script>

	<!-- Audio elements for alarm and arrival sounds -->
	<audio id="alarmSound" src="audio/alarm.mp3" preload="auto" loop></audio>
	<audio id="arrived1" src="audio/floor1arrived.mp3" preload="auto"></audio>
	<audio id="arrived2" src="audio/floor2arrived.mp3" preload="auto"></audio>
	<audio id="arrived3" src="audio/floor3arrived.mp3" preload="auto"></audio>
	<audio id="callSound" src="audio/Telephone.mp3" preload="auto"></audio>

	<!-- Bootstrap script -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-
		YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>

</html>